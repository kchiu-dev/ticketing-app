deploy:
  - envsubst < manifests/kustomization.template.yml > manifests/kustomization.yml
  - envsubst < tickets/.template.npmrc > tickets/.npmrc
  - okteto build -t okteto.dev/tickets:$OKTETO_GIT_COMMIT tickets
  - cd manifests; kustomize edit set image okteto/tickets:buildTag=okteto.dev/tickets:$OKTETO_GIT_COMMIT
  - envsubst < orders/.template.npmrc > orders/.npmrc
  - okteto build -t okteto.dev/orders:$OKTETO_GIT_COMMIT orders
  - cd manifests; kustomize edit set image okteto/orders:buildTag=okteto.dev/orders:$OKTETO_GIT_COMMIT
  - envsubst < gateway-dgraph/.template.npmrc > gateway-dgraph/.npmrc
  - okteto build -t okteto.dev/gateway-dgraph:$OKTETO_GIT_COMMIT gateway-dgraph
  - cd manifests; kustomize edit set image okteto/gateway-dgraph:buildTag=okteto.dev/gateway-dgraph:$OKTETO_GIT_COMMIT
  - envsubst < gateway/.template.npmrc > gateway/.npmrc
  - okteto build -t okteto.dev/gateway:$OKTETO_GIT_COMMIT gateway
  - cd manifests; kustomize edit set image okteto/gateway:buildTag=okteto.dev/gateway:$OKTETO_GIT_COMMIT
  - kustomize build manifests | kubectl apply -f -
  - sleep 3m
  - |
    echo Register Dgraph schemas
    TICKETS_POD=$(kubectl get pod -l app=tickets -o jsonpath="{.items[0].metadata.name}")
    ORDERS_POD=$(kubectl get pod -l app=orders -o jsonpath="{.items[0].metadata.name}")
    kubectl exec $TICKETS_POD -- curl -sX POST http://tickets-dgraph-srv:8080/admin/schema \
      --data-binary @src/dgraph/dgraph-schema.graphql
    echo
    kubectl exec $ORDERS_POD -- curl -sX POST http://orders-dgraph-srv:8080/admin/schema \
      --data-binary @src/dgraph/dgraph-schema.graphql